pipeline {
    agent any

    environment {
        AWS_ACCESS_KEY_ID = credentials('AWS')
        AWS_SECRET_ACCESS_KEY = credentials('AWS')
    } 

    stages {
        stage('Checkout') {
            steps {
                git credentialsId: 'Githubcreds', branch: 'custom_modules', url: 'https://github.com/devsecopsmurali/CICD_terraform.git'
            }
        }
         stage('Terraform init') {
            steps {
                sh 'cd dev_module_2;terraform init'
            }
        }
        stage('echo') {
            steps {
                sh 'echo "hi"'
            }
        }
        stage('Terraform refresh') {
            steps {
                sh 'cd dev_module_2;terraform refresh'
            }
        }
        stage('Terraform apply') {
            steps {
                sh "cd dev_module_2;terraform apply --auto-approve"
            }
        } 
         

         stage('Terraform output') {
    steps {
        script {
            def ec2InstanceId
            catchError {
                ec2InstanceId = sh(
                    script: 'cd dev_module_2;terraform output -raw ec2_id_test',
                    returnStdout: true
                ).trim()
            }
            echo "The EC2 instance ID is: ${ec2InstanceId}"
            env.EC2_INSTANCE_ID = ec2InstanceId
        }
    }
}
    

    stage('Validate Ansible') {
      input {
        message "Do you want to run Ansible Playbook?"
        ok "Run Ansible"
      }
      steps {
        echo "Ansible Accepted"
      }
    }

    stage('Run Ansible Playbook') {
    steps {
        def inventoryFile = "${EC2_INSTANCE_ID}"
        sh "ansible-playbook dev_module_2/config.yml -i ${inventoryFile}"
    }
}

    // stage('Run Ansible') {
    //   steps {
    //     ansiblePlaybook(inventory: '${EC2_INSTANCE_ID}', playbook: 'dev_module_2/config.yml')
    //   }
    // }


        // stage('Retrieve Host IPs') {
        //     steps {
        //         script {
        //             // Use Terraform output to retrieve host IPs
        //             def output = sh(script: 'terraform output -json', returnStdout: true).trim()
        //             def hostIPs = output =~ /"(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})"/
                    
        //             // Extract IPs from the match groups
        //             def ipsList = hostIPs.collect { it[1] }
        //             def hostIPsString = ipsList.join(',')
                    
        //             echo "Host IPs: $hostIPsString"
                    
        //             // Write host IPs to a file
        //             writeFile file: 'host_ips.txt', text: hostIPsString
        //         }
        //     }
        // }
        // stage('Ansible Configuration') {
        //     steps {
        //         // Run Ansible playbooks to configure provisioned hosts
        //         script {
        //             sh "ansible-playbook config.yml --extra-vars '@host_ips.txt'"
        //         }
        //     }
        // }
    }

    }
